<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>바코드 생성·스캔기</title>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    :root{
      --max-svg-width: 380px; /* 화면 표시 상한 (필요시 340~420px 등으로 조절) */
    }
    body { font-family: sans-serif; padding: 20px; }
    label { font-weight: bold; margin-top: 10px; display: block; text-align: center; }
    input, button {
      font-size: 1rem; padding: 8px; display: block; margin: 8px auto;
      width: 100%; max-width: 320px; box-sizing: border-box; text-align: center;
    }
    #barcodeSvg { display: block; margin: 20px auto 6px; width: 100%; max-width: var(--max-svg-width); }
    #productText {
      text-align: center;
      margin: 4px auto 12px;
      max-width: var(--max-svg-width);
      font-size: clamp(14px, 3vw, 24px); /* 모바일에서도 읽히는 크기 */
      line-height: 1.2;
      word-break: keep-all;
      overflow-wrap: anywhere;
    }
    #video { display: block; width: 100%; max-width: 600px; border: 1px solid #ccc; margin: 10px auto; }
    #scaleSlider { width: 80%; max-width: 420px; margin: 10px auto; display:block; }
    hr { margin: 30px 0; }

    /* 토스트 */
    #toast{
      position: fixed; left: 50%; top: 16px; transform: translateX(-50%);
      background: rgba(0,0,0,.8); color: #fff; padding: 10px 14px; border-radius: 10px;
      font-size: .9rem; opacity: 0; pointer-events: none; transition: opacity .25s ease;
      z-index: 9999;
    }
    #toast.show{ opacity: 1; }

    /* 다크모드 */
    @media (prefers-color-scheme: dark){
      body{ background:#111; color:#e8e8e8; }
      #video{ border-color:#444; }
      input,button{ background:#1a1a1a; color:#e8e8e8; border:1px solid #333; }
    }
  </style>
</head>
<body>
  <h1 style="text-align:center">
    바코드 생성기 <span style="font-size:.7em;font-weight:normal;">(CODE128 / v0.9.2)</span>
  </h1>

  <!-- 입력 순서: 숫자 → 상품명 -->
  <label for="codeInput">바코드 숫자 입력</label>
  <input id="codeInput" aria-label="바코드 숫자 입력"
         inputmode="numeric" pattern="\d*" autocomplete="off"
         placeholder="예: 123456789012" />

  <label for="productName">상품명 입력</label>
  <input id="productName" aria-label="상품명 입력" placeholder="예: 사과" />

  <!-- 크기 조절 -->
  <label for="scaleSlider">바코드 크기: <span id="scaleLabel">80%</span></label>
  <input type="range" id="scaleSlider" min="50" max="150" step="5" value="80" />

  <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
    <button id="downloadSvgBtn" aria-label="SVG로 저장">SVG 저장</button>
    <button id="downloadPngBtn" aria-label="PNG로 저장">PNG 저장</button>
  </div>

  <!-- 바코드(SVG) + 상품명(HTML) -->
  <svg id="barcodeSvg" xmlns="http://www.w3.org/2000/svg"></svg>
  <p id="productText"></p>

  <hr />

  <h1 style="text-align:center">바코드 스캔기</h1>
  <video id="video" playsinline></video>
  <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
    <button id="scanBtn">스캔 시작</button>
    <button id="stopBtn" style="display:none;">스캔 중지</button>
  </div>
  <label for="scanOutput">스캔 결과</label>
  <input id="scanOutput" readonly placeholder="여기에 코드가 표시됩니다" />

  <div id="toast" role="status" aria-live="polite"></div>

<script>
  /* ===== DOM ===== */
  const codeIn       = document.getElementById('codeInput');
  const nameIn       = document.getElementById('productName');
  const svgEl        = document.getElementById('barcodeSvg');
  const productEl    = document.getElementById('productText');
  const dlSvgBtn     = document.getElementById('downloadSvgBtn');
  const dlPngBtn     = document.getElementById('downloadPngBtn');
  const scaleSlider  = document.getElementById('scaleSlider');
  const scaleLabel   = document.getElementById('scaleLabel');
  const video        = document.getElementById('video');
  const scanBtn      = document.getElementById('scanBtn');
  const stopBtn      = document.getElementById('stopBtn');
  const scanOut      = document.getElementById('scanOutput');
  const toastEl      = document.getElementById('toast');
  let stream, detector;

  /* ===== 설정 ===== */
  let SCALE = parseInt(scaleSlider.value, 10) / 100; // 0.5~1.5
  const GAP   = 6; // (SVG 내부) 바코드 숫자와 하단 경계 간 여백 정도만 사용
  const MIN_FONT = 10; // 바코드 숫자 글꼴 최소 px

  /* ===== 유틸 ===== */
  function debounce(fn, wait=150){
    let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
  }
  function showToast(msg, ms=1200){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'), ms);
  }

  /* ===== 바코드 렌더(SVG) =====
     - 상품명은 SVG 밖(HTML p#productText)에 표시 → 모바일에서도 확실히 보임
  */
  function drawBarcode(code) {
    svgEl.innerHTML = '';
    svgEl.setAttribute('preserveAspectRatio', 'xMidYMin meet');

    const NS   = 'http://www.w3.org/2000/svg';
    const BAR_W = 2 * SCALE;                          // 막대 폭(px)
    const BAR_H = 60 * SCALE;                         // 막대 높이(px)
    const FONT  = Math.max(MIN_FONT, Math.round(14 * SCALE)); // 숫자 글꼴(정수/최소 보장)

    // 1) 바코드 치수 측정
    const tmp = document.createElementNS(NS, 'g');
    JsBarcode(tmp, code || '000000000000', {
      format: 'CODE128',
      width: BAR_W,
      height: BAR_H,
      displayValue: true,
      fontSize: FONT,
      textMargin: 5
    });
    svgEl.appendChild(tmp);
    const bbBar = tmp.getBBox();
    svgEl.removeChild(tmp);

    // 2) 뷰박스(바코드만 계산)
    const width  = bbBar.width;
    const height = bbBar.height + GAP;
    svgEl.setAttribute('viewBox', `0 0 ${width} ${height}`);

    // 3) 바코드 본체
    const g = document.createElementNS(NS, 'g');
    g.setAttribute('transform', `translate(0,0)`);
    JsBarcode(g, code || '000000000000', {
      format: 'CODE128',
      width: BAR_W,
      height: BAR_H,
      displayValue: true,
      fontSize: FONT,
      textMargin: 5
    });
    svgEl.appendChild(g);
  }

  function updateProductText(){
    productEl.textContent = nameIn.value.trim();
  }

  /* ===== 이벤트 ===== */
  const refresh = ()=>{ drawBarcode(codeIn.value.trim()); updateProductText(); };
  const refreshDebounced = debounce(refresh, 120);

  codeIn.addEventListener('input', refreshDebounced);
  nameIn.addEventListener('input', refreshDebounced);

  scaleSlider.addEventListener('input', ()=>{
    SCALE = parseInt(scaleSlider.value, 10) / 100;
    scaleLabel.textContent = scaleSlider.value + '%';
    refresh();
  });

  // 초기 렌더
  refresh();

  /* ===== 저장(SVG/PNG) ===== */
  dlSvgBtn.addEventListener('click', ()=>{
    const src  = new XMLSerializer().serializeToString(svgEl);
    const blob = new Blob([src], { type:'image/svg+xml' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = (codeIn.value.trim() || 'barcode') + '.svg';
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
  });

  // PNG 저장: 상품명까지 포함해서 저장
  dlPngBtn.addEventListener('click', ()=>{
    const xml = new XMLSerializer().serializeToString(svgEl);
    const dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(xml);
    const img = new Image();
    img.onload = ()=>{
      const name = nameIn.value.trim();
      // 2배 캔버스에 그려서 선명도 확보
      const padding = 12;
      const baseFontPx = Math.max(12, Math.round(14 * SCALE)); // PNG에서도 가독성 유지
      const c = document.createElement('canvas');
      const ctx = c.getContext('2d');

      // 상품명 폭 추정 위해 임시 폰트 설정 후 측정
      ctx.font = `${baseFontPx}px sans-serif`;
      const textW = name ? ctx.measureText(name).width : 0;
      const outW = Math.max(img.width*2, Math.ceil(textW) + padding*2);
      const textH = name ? baseFontPx + 4 : 0;
      const outH = img.height*2 + (name ? (padding + textH) : 0);

      c.width = outW; c.height = outH;

      // 배경 흰색 (투명 PNG 원하면 주석 처리)
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,c.width,c.height);

      // 바코드 중앙 배치
      const imgX = Math.round((outW - img.width*2)/2);
      ctx.drawImage(img, imgX, 0, img.width*2, img.height*2);

      // 상품명
      if(name){
        ctx.fillStyle = '#000';
        ctx.font = `${baseFontPx}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.fillText(name, outW/2, img.height*2 + padding);
      }

      c.toBlob(b=>{
        const url = URL.createObjectURL(b);
        const a = document.createElement('a');
        a.href = url; a.download = (codeIn.value.trim() || 'barcode') + '.png';
        document.body.appendChild(a); a.click();
        document.body.removeChild(a); URL.revokeObjectURL(url);
      }, 'image/png');
    };
    img.src = dataUrl;
  });

  /* ===== 스캔 ===== */
  function showScanError(){
    alert('이 브라우저는 스캔 기능을 지원하지 않습니다. (Chrome/Edge 권장)');
  }

  scanBtn.addEventListener('click', async ()=>{
    scanBtn.style.display='none'; stopBtn.style.display='';
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }
      });
    }catch{
      alert('카메라 권한을 허용해주세요.');
      resetScan(); return;
    }
    video.srcObject = stream; await video.play();

    if(!('BarcodeDetector' in window)){ showScanError(); resetScan(); return; }
    detector = new BarcodeDetector({ formats:['code_128','ean_13','ean_8','upc_a','upc_e'] });
    requestAnimationFrame(scanFrame);
  });

  async function scanFrame(){
    try{
      const res = await detector.detect(video);
      if(res.length){
        const v = res[0].rawValue;
        codeIn.value = scanOut.value = v;
        try{ await navigator.clipboard?.writeText(v); }catch{}
        showToast('스캔 성공: ' + v);
        refresh();
        stopScan();
      }else{
        requestAnimationFrame(scanFrame);
      }
    }catch(e){
      console.error(e); stopScan();
    }
  }
  function stopScan(){
    if(stream) stream.getTracks().forEach(t=>t.stop());
    resetScan();
  }
  function resetScan(){ scanBtn.style.display=''; stopBtn.style.display='none'; }
  stopBtn.addEventListener('click', stopScan);

  /* ===== URL 파라미터로 바로 생성 (선택) =====
     예: ?code=8801234567890&name=사과&scale=90
  */
  (function initFromQuery(){
    const q = new URLSearchParams(location.search);
    const codeQ = q.get('code'); const nameQ = q.get('name'); const scaleQ = q.get('scale');
    if(codeQ){ codeIn.value = codeQ; }
    if(nameQ){ nameIn.value = nameQ; }
    if(scaleQ){
      const v = Math.min(150, Math.max(50, parseInt(scaleQ,10)||80));
      scaleSlider.value = v; SCALE = v/100; scaleLabel.textContent = v+'%';
    }
    refresh();
  })();
</script>
</body>
</html>

