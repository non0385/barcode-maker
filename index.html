<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>바코드 생성·스캔기</title>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<style>
  :root {
    --max-svg-width: 380px; /* 초기 최대 폭(px) */
  }
  body {
    font-family: sans-serif;
    padding: 20px;
  }
  label {
    font-weight: bold;
    margin-top: 10px;
    display: block;
    text-align: center;
  }
  input, button {
    font-size: 1rem;
    padding: 8px;
    display: block;
    margin: 8px auto;
    width: 100%;
    max-width: 300px;
    box-sizing: border-box;
    text-align: center;
  }
  #barcodeSvg {
    display: block;
    margin: 10px auto;
    width: 100%;
    max-width: var(--max-svg-width);
  }
  #productText {
    max-width: var(--max-svg-width);
    margin: 4px auto 12px;
    text-align: center;
    font-size: clamp(16px, 4vw, 28px);
    font-weight: bold;
    line-height: 1.2;
    overflow-wrap: anywhere;
  }
  #video {
    display: block;
    width: 100%;
    max-width: 600px;
    border: 1px solid #ccc;
    margin: 10px auto;
  }
  hr {
    margin: 30px 0;
  }
  #scaleContainer {
    text-align: center;
    margin: 10px auto;
    max-width: 300px;
  }
</style>
</head>
<body>
<h1 style="text-align:center">
  바코드 생성기<br>
  <span style="font-size:.7em;font-weight:normal;">(CODE128 / v0.9.3)</span>
</h1>

<!-- 입력 -->
<label for="codeInput">바코드 숫자 입력:</label>
<input id="codeInput" placeholder="예: 123456789012">

<label for="productName">상품명 입력:</label>
<input id="productName" placeholder="예: 사과">

<!-- 크기 조절 슬라이더 -->
<div id="scaleContainer">
  <label for="scaleSlider">바코드 크기: <span id="scaleLabel">100%</span></label>
  <input type="range" id="scaleSlider" min="50" max="150" value="100">
</div>

<!-- 바코드 & 상품명 -->
<svg id="barcodeSvg" xmlns="http://www.w3.org/2000/svg"></svg>
<div id="productText"></div>

<button id="downloadBtn">바코드 저장</button>

<hr>

<h1 style="text-align:center">바코드 스캔기</h1>
<video id="video" playsinline></video>
<button id="scanBtn">스캔 시작</button>
<button id="stopBtn" style="display:none;">스캔 중지</button>
<label for="scanOutput">스캔 결과:</label>
<input id="scanOutput" readonly placeholder="여기에 코드가 표시됩니다">

<script>
/* DOM 요소 */
const prodIn = document.getElementById('productName');
const codeIn = document.getElementById('codeInput');
const svgEl = document.getElementById('barcodeSvg');
const dlBtn = document.getElementById('downloadBtn');
const video = document.getElementById('video');
const scanBtn = document.getElementById('scanBtn');
const stopBtn = document.getElementById('stopBtn');
const scanOut = document.getElementById('scanOutput');
const scaleSlider = document.getElementById('scaleSlider');
const scaleLabel = document.getElementById('scaleLabel');
const productText = document.getElementById('productText');
let stream, detector;

/* 초기 크기 */
let SCALE = parseInt(scaleSlider.value, 10) / 100;

/* 바코드 렌더링 */
function draw(code) {
  svgEl.innerHTML = '';
  const name = prodIn.value.trim();
  productText.textContent = name; // 상품명은 SVG 아래 별도 표시

  const barWidth = 2 * SCALE;
  const barHeight = 60 * SCALE;
  const fontSize = Math.round(14 * SCALE);

  JsBarcode(svgEl, code, {
    format: "CODE128",
    width: barWidth,
    height: barHeight,
    displayValue: true,
    fontSize: fontSize,
    textMargin: 5
  });
}

/* 입력 즉시 렌더 */
const refresh = () => draw(codeIn.value.trim() || '000000000000');
codeIn.addEventListener('input', refresh);
prodIn.addEventListener('input', refresh);
refresh();

/* 크기 슬라이더 변경 */
scaleSlider.addEventListener('input', () => {
  SCALE = parseInt(scaleSlider.value, 10) / 100;
  scaleLabel.textContent = scaleSlider.value + '%';
  const base = 380; // px
  document.documentElement.style.setProperty(
    '--max-svg-width', Math.round(base * SCALE) + 'px'
  );
  refresh();
});

/* 다운로드 */
dlBtn.addEventListener('click', () => {
  const src = new XMLSerializer().serializeToString(svgEl);
  const blob = new Blob([src], {type: 'image/svg+xml'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (codeIn.value.trim() || 'barcode') + '.svg';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

/* 스캔 */
scanBtn.addEventListener('click', async () => {
  scanBtn.style.display = 'none';
  stopBtn.style.display = '';
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720}}
    });
  } catch {
    alert('카메라 권한 허용 필요');
    reset();
    return;
  }
  video.srcObject = stream;
  await video.play();
  if (!('BarcodeDetector' in window)) {
    alert('스캔 미지원');
    reset();
    return;
  }
  detector = new BarcodeDetector({formats: ['code_128', 'ean_13', 'ean_8', 'upc_a', 'upc_e']});
  requestAnimationFrame(scanFrame);
});
async function scanFrame() {
  try {
    const r = await detector.detect(video);
    if (r.length) {
      const v = r[0].rawValue;
      codeIn.value = scanOut.value = v;
      refresh();
      stop();
    } else {
      requestAnimationFrame(scanFrame);
    }
  } catch (e) {
    console.error(e);
    stop();
  }
}
function stop() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  reset();
}
function reset() {
  scanBtn.style.display = '';
  stopBtn.style.display = 'none';
}
stopBtn.addEventListener('click', stop);
</script>
</body>
</html>
